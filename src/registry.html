<html lang="en">
<!-- include head.html -->

<body>
<!-- include header.html -->

<div>
  <div class="modal mymodal fade" id="regDialog" data-keyboard="false" role="dialog" aria-labelledby="regDialogLabel" ariai-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="regDialogLabel"></h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          </button>
        </div>
        <div class="modal-body">
          <p id="regDialogText">
          </p>
          <p>
          This gift is available at the above link, but an equivalent one can be bought anywhere.
          </p>
          <p>
          If you wish to mark this gift as taken, please submit your name. This will be kept private but will make the gift unavailable to other guests.
          </p>
          <form>
            <div class="form-group">
              <input type="text" class="form-control" placeholder="Your Name" id="regName"></input>
            </div>
          </form>
        </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="regSubmitBtn">Submit</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>
      </div>
    </div>
  </div>

  <div class="modal mymodal fade" id="regSuccess" tabindex="-1" role="dialog" aria-labelledby="regSuccessLabel" ariai-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="regSuccessLabel">Success</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          </button>
        </div>
        <div class="modal-body">
          <p>Successfully updated.</p>
          <p>Thank you so much!</p>
        </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
      </div>
      </div>
    </div>
  </div>

  <h2>Registry</h2>
  <p>
  Your presence is the greatest present we could ask for. However, if you really want to grace us with a gift, we have picked out a few suggestions.
  </p>

  <div class="row spacious" id="regTable">
  </div>
</div>

<!-- include footer.html -->

<script>
    $(document).ready(function(){
        console.log("Loading registry")
        windowInit("registry");
        firebaseInit();
        $("#regSubmitBtn").click(regSubmitted);
        refreshRegistry();
    });

<!-- include window.js -->
<!-- include firebase.js -->

    function refreshRegistry() {
        $("#regTable").empty();
        $("#regTable").append('<div class="spinner-border myspinner" role="status"></div>');

        firebase.database().ref('registry').once("value").then(
            refreshRegistryElements,
            function(error) {
                alert("Sorry! something went wrong and the registry did not load\nPlease contact zoepeterwedding2020@gmail.com");
            });
    }

    function registryDialog(giftname) {
        var obj = registry[giftname];
        giftSelected = giftname;  // make global
        $("#regDialogLabel").text(giftname);
        $("#regDialogText").text(obj.text+" "+obj.quantity);
        $("#regDialog").modal("show");
    }

    function regSubmitted() {
        var name= $("#regName").val();
        if( name=="" || giftSelected=="" ){
            return;
        }

        $("#regTable").empty();
        $("#regTable").append('<div class="spinner-border myspinner" role="status"></div>');

        // timestamp
        var ts = +new Date();

        // Increment counter by pushing to it
        $("#regDialog").modal("hide");
        firebase.database().ref('registry')
            .child(giftSelected).child("counter").push().set(ts)
            .then( function(snapshot) {
                console.log("updated gift counter");
                // Record the name
                firebase.database().ref('registryNames')
                    .child(giftSelected).push().set({"name":name, "timestamp":ts})
                    .then( function(snapshot) {
                        $("#regSuccess").modal("show");
                        console.log("Successfully posted name to private part of database");
                    }, function(error) {
                        alert("Sorry, something went wrong and your registry submission was not accepted!\nCould you please conact zoepeterwedding2020@gmail.com instead");
                    }
                    );
                refreshRegistry();
            }, function(error) {
                alert("Sorry, something went wrong and your registry submission was not accepted!\nCould you please conact zoepeterwedding2020@gmail.com instead");
            }
            );
    }

    function refreshRegistryElements(snapshot) {
        $("#regTable").empty();
        giftSelected = "";  // initially no gift is selected

        // for all gifts in the registry:
        registry = snapshot.val();
        for( var giftname in registry ){
            console.log("Loading "+giftname);
            var obj = registry[giftname];
            var numAlloc = 0;
            if( obj.counter ){
                numAlloc = Object.keys(obj.counter).length;
            }
            if( numAlloc < obj.quantity ){
                var lnkProps = {"class":"regLink", "onclick":"registryDialog('"+giftname+"')"};
                var lnkText = obj.text+' ('+numAlloc+' of '+obj.quantity+')';
            }else{
                var lnkProps = {"class":"regLink"};
                var lnkText = obj.text+' (unavailable)';
                //TODO apply some sort of grayed out effect / remove hover effect?
            }
            var col = $("<div></div>", {"class":"col-md-4"});
            var lnk = $("<div></div>", lnkProps);
            lnk.append($("<img></img>", {"class":"regImg", "src":obj.img, "alt":giftname, "style":"width:100%"}));
            lnk.append('<div class="caption"><p>'+lnkText+'</p></div>');
            col.append(lnk);
            $("#regTable").append(col);
        }
    }
</script>

</body>
</html>
